<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,initial-scale=1,user-scalable=yes"/>
	<style>
		html, body {
			padding: 0;
			margin: 0;
			height: 100%;
		}
		body {
			font-family: monospace;
			box-sizing: border-box;
			display: flex;
			flex-direction: column;
			font-size: 16px;
		}
		.red {
			color: #cc0000;
		}
		.green {
			color: #59b101;
		}
		#log {
			padding: 10px;
			white-space: pre;
		}
		#map {
			flex: 1;
		}
	</style>
</head>
<body>

	<div id="log">Drop files here</div>
	<div id="map"></div>

	<script type="module">
		import * as exifr from '../src/bundle-full.js'
		import {gpsOnlyOptions, Exifr} from '../src/bundle-full.js'


		let $log = document.querySelector('#log')
		let memUsed = 0

		let dropzone = document.body
		dropzone.addEventListener('dragenter', e => e.preventDefault())
		dropzone.addEventListener('dragover', e => e.preventDefault())
		dropzone.addEventListener('drop', async e => {
			e.preventDefault()
			let files = Array.from(e.dataTransfer.files)
			let totalBytes = sum(files.map(f => f.size))
			let time = await processImages(files)
			$log.innerHTML = [
				`files:       <strong>${files.length}</strong> = <strong class="red">${(totalBytes / 1024 / 1024).toFixed(1)} MB</strong>`,
				`parsed in:   <strong class="green">${Math.floor(time)} ms</strong> (${(time / files.length).toFixed(1)} ms per file)`,
				`used memory: <strong class="green">${(memUsed / 1024 / 1024).toFixed(1)} MB</strong> (${((memUsed / totalBytes) * 100).toFixed(1)}%)`,
			].join('\n')
		})

		async function processImages(files) {
			memUsed = 0
			let t1 = performance.now()
			let promises = files.map(processImage)
			//let promises = files.map(exifr.gps)
			let coords = await Promise.all(promises)
			let t2 = performance.now()
			return t2 - t1
		}

		async function processImage(file) {
			let exr = new Exifr(gpsOnlyOptions)
			await exr.read(file)
			let output = await exr.parse()
			memUsed += exr.file.byteLength
			return output
		}

		function sum(arr) {
			let num = 0
			for (let item of arr) num += item
			return num
		}

	</script>

</body>
</html>